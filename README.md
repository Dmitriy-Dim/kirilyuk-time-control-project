# Time Control API

REST API для учета рабочего времени сотрудников в малом бизнесе. Система позволяет управлять персоналом, отслеживать рабочие смены, перерывы и контролировать соблюдение трудового законодательства.

## Основные возможности

### Управление персоналом
- Найм и увольнение сотрудников
- Обновление личных данных
- Смена паролей и ролей
- Проверка на повторное трудоустройство уволенных сотрудников

### Учет рабочего времени
- Начало и завершение рабочих смен
- Автоматический расчет отработанных часов
- Регистрация перерывов (15 или 30 минут)
- Контроль максимальной продолжительности смены
- Минимальный отдых между сменами

### Управленческие функции
- Коррекция времени смен менеджерами
- Просмотр текущего состава смены
- Статистика по месячным часам
- Проверка возможности начала смены

## Технические требования

- Node.js >= 18.0
- MongoDB >= 5.0
- npm или yarn

## Установка и запуск

### 1. Клонирование репозитория
```bash
git clone <repository-url>
cd time-control-api
```

### 2. Установка зависимостей
```bash
npm install
```

### 3. Настройка окружения
Создайте файл `.env`:
```env
OWNER=100000000
OWNER_PASS=123456789.com
MONGO_URI=mongodb+srv://
JWT_SECRET=super-secret-key-for-jwt-token
```

### 4. Запуск приложения

#### Режим разработки
```bash
npm run dev
```

#### Продакшн
```bash
npm run build
npm start
```

## API Endpoints

### Управление сотрудниками (`/accounts`)

| Метод | Путь | Описание |
|-------|------|----------|
| POST | `/accounts` | Нанять сотрудника |
| GET | `/accounts` | Получить всех сотрудников |
| GET | `/accounts/employee` | Получить сотрудника по ID |
| PATCH | `/accounts` | Обновить данные сотрудника |
| PATCH | `/accounts/password` | Сменить пароль |
| PATCH | `/accounts/set_role` | Установить роль |
| DELETE | `/accounts` | Уволить сотрудника |

### Управление сменами (`/shifts`)

| Метод | Путь | Описание |
|-------|------|----------|
| POST | `/shifts/start` | Начать смену |
| POST | `/shifts/finish` | Завершить смену |
| POST | `/shifts/break` | Зарегистрировать перерыв |
| PATCH | `/shifts/correct` | Корректировать смену (менеджер) |
| GET | `/shifts/current` | Текущий состав смены |
| GET | `/shifts/employee` | Активная смена сотрудника |
| GET | `/shifts/can-start` | Проверка возможности начать смену |

## Примеры использования

### Найм нового сотрудника
```bash
curl -X POST http://localhost:3555/accounts \
  -H "Content-Type: application/json" \
  -d '{
    "id": "123456789",
    "firstName": "John",
    "lastName": "Snow",
    "password": "SecurePass123"
  }'
```

### Начало рабочей смены
```bash
curl -X POST http://localhost:3555/shifts/start \
  -H "Content-Type: application/json" \
  -d '{
    "table_num": "f47ac10b-58cc-4372-a567-0e02b2c3d479"
  }'
```

### Регистрация перерыва
```bash
curl -X POST http://localhost:3555/shifts/break \
  -H "Content-Type: application/json" \
  -d '{
    "table_num": "f47ac10b-58cc-4372-a567-0e02b2c3d479",
    "duration": 15
  }'
```

## Структура данных

### Роли пользователей
- `crew` - Рядовой сотрудник
- `manager` - Менеджер
- `hr` - HR-специалист
- `supervisor` - Супервайзер

### Длительность перерывов
- `15` минут - короткий перерыв
- `30` минут - длинный перерыв

### Правила перерывов
- Смена < 4 часов: перерывы не разрешены
- Смена 4-6 часов: до 15 минут перерывов
- Смена > 6 часов: до 30 минут перерывов

## Валидация данных

Приложение использует Joi для валидации входящих данных:

- **ID сотрудника**: ровно 9 символов
- **Пароль**: минимум 8 символов, только буквы и цифры
- **Имя/Фамилия**: не пустые строки
- **Дата**: формат YYYY-MM-DD

## Обработка ошибок

API возвращает стандартные HTTP коды состояния:

- `200` - Успешная операция
- `201` - Ресурс создан
- `400` - Ошибка валидации
- `404` - Ресурс не найден
- `409` - Конфликт (дублирование)
- `500` - Внутренняя ошибка сервера

Формат ошибки:
```json
{
  "error": "Employee with id 123456789 not found"
}
```

## Логирование

Система использует Winston для логирования:
- Информационные сообщения о действиях пользователей
- Предупреждения о некорректных запросах
- Ошибки с полным контекстом запроса

## База данных

### Коллекции MongoDB

- `employees_accounting` - активные сотрудники
- `fired_emp_collection` - уволенные сотрудники
- `crew_shifts` - рабочие смены

### Индексы
- `table_num + startShift` - для быстрого поиска смен
- `shift_id` - уникальные идентификаторы смен
- `startShift` - сортировка по времени

## Архитектура

Приложение следует принципам Clean Architecture:

```
app-config/         # Конфигурационные файлы
docs/              # Документация проекта
src/
├── controllers/   # HTTP контроллеры
├── config/        # Настройки приложения
├── logger/        # Настройка логирования
├── routes/        # Маршрутизация
├── services/      # Бизнес-логика
├── model/         # Модели данных и схемы MongoDB
├── utils/         # Утилиты и вспомогательные функции
├── validation/    # Joi схемы валидации
├── errorHandler/  # Обработка ошибок
├── app.ts         # Настройка Express приложения
└── server.ts      # Точка входа сервера
tests/             # Тесты приложения
```

## Тестирование

Запуск тестов:
```bash
npm test
```

Покрытие кода:
```bash
npm run test:coverage
```

Тесты написаны с использованием Jest и покрывают:
- Сервисные методы
- Валидацию данных
- Обработку ошибок

## API Документация

Полная OpenAPI 3.0 спецификация доступна в файле `openapi.json`.
Для просмотра используйте Swagger UI:

```bash
# Установка swagger-ui-express (опционально)
npm install swagger-ui-express
```

## Безопасность

- Пароли хешируются с использованием bcrypt
- Валидация всех входящих данных
- Логирование подозрительных действий
- Проверка ролей для административных операций

## Развитие и вклад в проект

1. Форкните репозиторий
2. Создайте ветку для новой функции (`git checkout -b feature/new-feature`)
3. Зафиксируйте изменения (`git commit -am 'Add new feature'`)
4. Отправьте в ветку (`git push origin feature/new-feature`)
5. Создайте Pull Request

## Лицензия



## Поддержка

По вопросам и предложениям создавайте issues в репозитории или обращайтесь к команде разработки.